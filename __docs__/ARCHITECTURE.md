# SWEAP Game - アーキテクチャドキュメント

## 概要

SWEAP Gameは、TypeScript + PixiJS + PWAで構築された高性能な60FPS Webマインスイーパーゲームです。モジュラー設計により機能が明確に分離され、各システムが独立して動作する設計となっています。

## アーキテクチャ原則

### 1. 単一責任原則 (Single Responsibility Principle)
各クラスは単一の責任のみを持ち、変更理由も単一となるよう設計されています。

### 2. 依存性注入 (Dependency Injection)
ServiceContainerパターンにより、依存関係が明確化され、テスタビリティが向上しています。

### 3. イベント駆動設計 (Event-Driven Design)
システム間の疎結合を実現し、拡張性と保守性を確保しています。

## システム構成

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Game (Main)   │    │  ServiceContainer│    │   GameLogic     │
│                 │ -> │                 │ -> │                 │
│ - 統合管理      │    │ - 依存性注入    │    │ - ゲームルール  │
│ - ライフサイクル│    │ - サービス管理  │    │ - 状態管理      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                                              │
         │                                              │
         v                                              v
┌─────────────────────────────────────────────────────────────────┐
│                    Rendering Layer                              │
├─────────────────┬─────────────────┬─────────────────┬───────────┤
│  PixiAppManager │   GridManager   │  CellRenderer   │GridEventH│
│                 │                 │                 │andler    │
│ - PIXI初期化    │ - グリッド管理  │ - セル描画      │- イベント│
│ - リソース管理  │ - レイアウト    │ - 視覚エフェクト│  処理    │
└─────────────────┴─────────────────┴─────────────────┴──────────┘
         │                       │                       │
         │                       │                       │
         v                       v                       v
┌─────────────────┬─────────────────┬─────────────────┬───────────┤
│ AnimationEngine │   SoundManager  │   StatsManager  │   UIManager│
│                 │                 │                 │           │
│ - TweenEngine   │ - 音響効果      │ - 統計追跡      │ - UI表示  │
│ - EasingFunctions│ - BGM制御      │ - 実績システム  │ - 更新制御│
│ - HighLevelAnims│ - 設定連携      │ - データ永続化  │ - イベント│
└─────────────────┴─────────────────┴─────────────────┴───────────┘
```

## コアコンポーネント

### Game (src/game/Game.ts)
**責任**: アプリケーション全体のライフサイクル管理
- サービスコンテナの初期化
- システム間の協調制御
- 設定適用とイベント配線

### ServiceContainer (src/core/ServiceContainer.ts)
**責任**: 依存性注入とサービス管理
- シングルトン/トランジェントサービス管理
- 循環依存の検出
- ライフサイクル制御

### GameLogic (src/game/GameLogic.ts)
**責任**: ピュアなゲームロジック
- マインスイーパーのルール実装
- ゲーム状態管理
- セル操作とフラグ管理

## レンダリングアーキテクチャ

### 責任分離設計

#### PixiAppManager
- PIXIアプリケーションの初期化
- WebGLコンテキスト管理
- リソースライフサイクル

#### GridManager
- セルグリッドの作成・配置
- 表示更新の統括
- レイアウト計算

#### CellRenderer
- 個別セルの描画
- 状態別ビジュアル生成
- 数字・フラグ・地雷の描画

#### GridEventHandler
- マウス・タッチイベント処理
- セル操作の判定
- ホバーエフェクト管理

## アニメーションシステム

### 3層アーキテクチャ

#### TweenEngine (低レベル)
- 基本的なプロパティ補間
- パフォーマンス最適化
- RequestAnimationFrame制御

#### EasingFunctions (中レベル)
- 数学的イージング関数群
- アニメーション曲線定義
- 視覚効果の基盤

#### HighLevelAnimations (高レベル)
- フェード、バウンス、シェイク等
- ゲーム固有のアニメーション
- 使いやすいAPI提供

## 状態管理

### ゲーム状態フロー
```
    READY
      │
      │ (初回クリック)
      ▼
    ACTIVE ──┐
      │      │
      │      │ (ポーズ)
      │      ▼
      │    PAUSED
      │      │
      │      │ (再開)
      │      └─────────┐
      │                │
      │ (ゲーム終了)   │
      ▼                ▼
   SUCCESS         ACTIVE
   FAILED
```

### 設定管理
- ユーザー設定の永続化
- リアルタイム設定反映
- 型安全な設定検証

## パフォーマンス最適化

### メモリ管理
- ObjectPoolによるGC負荷軽減
- シングルトンパターンでインスタンス削減
- 適切なリソース破棄

### レンダリング最適化
- WebGLレンダリング（60FPS維持）
- RequestAnimationFrame使用
- 効率的な表示更新

### アセット管理
- 遅延読み込み
- リソースキャッシュ
- PWAによるオフライン対応

## エラーハンドリング

### 階層化エラー処理
1. **システムレベル**: ServiceContainer例外処理
2. **アプリケーションレベル**: Game初期化エラー
3. **UIレベル**: ユーザーフレンドリーなエラー表示

### エラー種別
- `GameInitializationError`: 初期化失敗
- `ServiceResolutionError`: サービス解決失敗
- `RenderingError`: 描画エラー

## テスト戦略

### 単体テスト
- 純粋関数のテスト
- モック/スタブ活用
- 依存性注入によるテスト容易性

### 統合テスト
- サービス間連携テスト
- エンドツーエンドシナリオ
- パフォーマンステスト

## 拡張ポイント

### 新機能追加時の指針
1. **単一責任**: 新機能は専用クラスで実装
2. **依存性注入**: ServiceContainerに登録
3. **イベント駆動**: 既存システムとの疎結合
4. **型安全性**: TypeScriptの型システム活用

### 一般的な拡張例
- 新しい難易度レベル → DIFFICULTY_CONFIGS追加
- 新しいアニメーション → HighLevelAnimations拡張
- 新しい統計項目 → StatsManager拡張
- 新しい音響効果 → SoundManager拡張

## 品質保証

### 静的解析
- TypeScript厳格モード
- ESLint with TypeScript
- 型カバレッジ100%

### パフォーマンス監視
- PerformanceMonitorによるリアルタイム監視
- メモリリーク検出
- FPS監視

この設計により、SWEAP Gameは高いパフォーマンスと保守性を両立した、スケーラブルなWebゲームとなっています。